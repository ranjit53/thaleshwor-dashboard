<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thaleshwor Yuva Samuh - Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    .sidebar-link { @apply flex items-center px-6 py-4 text-base font-bold rounded-xl transition-colors duration-200; }
    .sidebar-link:hover { @apply bg-gray-100 text-gray-900; }
    .sidebar-link.active { @apply bg-blue-100 text-blue-700 font-extrabold; }
    .sidebar-icon { @apply w-5 h-5 mr-3; }
    .stat-card { @apply bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between; }
    .chart-container { @apply bg-white p-6 rounded-xl shadow-sm border border-gray-200; }
    .badge-active { @apply bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs; }
    .badge-inactive { @apply bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs; }
    main { min-height: 100vh; }
    .form-grid { @apply grid grid-cols-1 md:grid-cols-2 gap-4; }
    .form-grid .full { @apply md:col-span-2; }
    .small-chart { height: 250px !important; }
  </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white font-bold text-lg">T</div>
        <div class="ml-3">
          <h2 class="text-xl font-bold">Thaleshwor</h2>
          <p class="text-xs text-gray-500">Yuva Samuh</p>
        </div>
      </div>
      <form onsubmit="handleSignIn(event)" class="space-y-4">
        <input id="signinEmail" type="email" placeholder="Email" value="example.admin@gmail.com" required class="w-full px-4 py-2 border rounded-md">
        <input id="signinPassword" type="password" placeholder="Password" value="admin2082" required class="w-full px-4 py-2 border rounded-md">
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Sign In</button>
        <p class="text-xs text-center text-gray-500 mt-3">Default: <strong>example@gmail.com</strong> / <strong>example123</strong></p>
      </form>
    </div>
  </div>

  <div id="app" class="hidden flex">

    <aside class="bg-white shadow-md flex flex-col h-screen w-64 fixed left-0 top-0 border-r z-20">
      <div class="p-6 border-b">
        <div class="flex items-center">
          <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white font-bold text-lg">T</div>
          <div class="ml-3">
            <h2 class="text-xl font-bold text-gray-800">Thaleshwor</h2>
            <p class="text-xs text-gray-500">Yuva Samuh</p>
          </div>
        </div>
      </div>

      <nav class="flex flex-col flex-1 overflow-y-auto px-3 py-4 space-y-1">
        <a href="#" id="nav-dashboard" onclick="showSection('dashboard')" class="sidebar-link active">
          <i class="fas fa-tachometer-alt sidebar-icon text-blue-600"></i> Dashboard
        </a>
        <a href="#" id="nav-members" onclick="showSection('members')" class="sidebar-link">
          <i class="fas fa-users sidebar-icon text-purple-600"></i> Members
        </a>
        <a href="#" id="nav-savings" onclick="showSection('savings')" class="sidebar-link">
          <i class="fas fa-piggy-bank sidebar-icon text-green-600"></i> Savings
        </a>
        <a href="#" id="nav-loans" onclick="showSection('loans')" class="sidebar-link">
          <i class="fas fa-hand-holding-usd sidebar-icon text-orange-600"></i> Loans
        </a>
        <a href="#" id="nav-payments" onclick="showSection('payments')" class="sidebar-link">
          <i class="fas fa-file-invoice-dollar sidebar-icon text-pink-600"></i> Payments
        </a>
        <a href="#" id="nav-settings" onclick="showSection('settings')" class="sidebar-link">
          <i class="fas fa-cog sidebar-icon text-gray-600"></i> Settings
        </a>
      </nav>

      <div class="mt-auto border-t p-4">
        <div class="flex items-center space-x-3">
          <div id="userAvatarSmall" class="w-9 h-9 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">R</div>
          <div>
            <p id="userNameSmall" class="text-sm font-medium text-gray-900">Ranjit Singh</p>
            <p id="userRoleSmall" class="text-xs text-gray-500">admin</p>
            <button onclick="logout()" class="mt-2 text-xs text-red-600 hover:text-red-700"><i class="fas fa-sign-out-alt mr-1"></i>Logout</button>
          </div>
        </div>
      </div>
    </aside>

    <main class="flex-1 ml-64 p-8 overflow-y-auto min-h-screen">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 id="headerTitle" class="text-2xl font-bold text-gray-800">Dashboard</h1>
          <p id="headerSubtitle" class="text-sm text-gray-600">Cooperative Microfinance Overview</p>
        </div>
      </div>

      <section id="section-dashboard">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Total Members</p>
              <p class="text-2xl font-bold" id="stat-members">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
              <i class="fas fa-users text-blue-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Total Savings</p>
              <p class="text-2xl font-bold" id="stat-savings">रु0</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
              <i class="fas fa-piggy-bank text-green-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Active Loans</p>
              <p class="text-2xl font-bold" id="stat-loans">रु0</p>
            </div>
            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
              <i class="fas fa-hand-holding-usd text-orange-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Interest Collected</p>
              <p class="text-2xl font-bold text-purple-600" id="stat-interest">रु0</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
              <i class="fas fa-percentage text-purple-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Available Balance</p>
              <p class="text-2xl font-bold text-green-600" id="stat-balance">रु0</p>
            </div>
            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
              <i class="fas fa-balance-scale text-indigo-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Growth Rate</p>
              <p class="text-2xl font-bold text-green-600" id="stat-growth">+0%</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
              <i class="fas fa-arrow-up text-purple-600"></i>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Savings & Loans Growth</h3>
            <canvas id="lineChart" class="small-chart"></canvas>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Loan Distribution by Member</h3>
            <canvas id="pieChart" class="small-chart"></canvas>
          </div>
        </div>

        <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-8">
          <div class="flex items-center mb-3">
            <div class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs mr-2">!</div>
            <h3 class="font-semibold text-red-800">Monthly Defaulters</h3>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-red-100 p-3 rounded-lg">
              <p class="text-sm font-medium">Savings Defaulters</p>
              <p class="text-2xl font-bold text-red-800" id="defaulters-savings">0</p>
            </div>
            <div class="bg-orange-100 p-3 rounded-lg">
              <p class="text-sm font-medium">Loan Interest Defaulters</p>
              <p class="text-2xl font-bold text-orange-800" id="defaulters-loans">0</p>
            </div>
          </div>
        </div>
      </section>

      <section id="section-members" class="hidden">
        <div class="flex justify-end mb-4">
          <button onclick="showAddMemberForm()" class="admin-only bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">+ Add Member</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4">
            <p class="font-medium">All Members (<span id="member-count">0</span>)</p>
            <input type="text" placeholder="Search..." onkeyup="searchTable('member-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="member-table">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">ID</th>
                  <th class="text-left p-3">Name</th>
                  <th class="text-left p-3">Phone</th>
                  <th class="text-left p-3">Join Date</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="member-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="section-savings" class="hidden">
        <div class="flex justify-end mb-4">
          <button onclick="showSavingForm()" class="admin-only bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">+ Record Saving</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4">
            <p class="font-medium">Savings by Member (<span id="saving-count">0</span>)</p>
            <input type="text" placeholder="Search..." onkeyup="searchTable('saving-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="saving-table">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Member</th>
                  <th class="text-left p-3">Total (रु)</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="saving-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="section-loans" class="hidden">
        <div class="flex justify-end mb-4">
          <button onclick="showLoanForm()" class="admin-only bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 text-sm">+ Distribute Loan</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4">
            <p class="font-medium">All Loans (<span id="loan-count">0</span>)</p>
            <input type="text" placeholder="Search..." onkeyup="searchTable('loan-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="loan-table">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Member</th>
                  <th class="text-left p-3">Principal (रु)</th>
                  <th class="text-left p-3">Balance (रु)</th>
                  <th class="text-left p-3">Rate (%)</th>
                  <th class="text-left p-3">Date</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="loan-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="section-payments" class="hidden">
        <div class="flex justify-end mb-4">
          <button onclick="showPaymentForm()" class="admin-only bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-sm">+ Record Payment</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4">
            <p class="font-medium">Payments by Loan (<span id="payment-count">0</span>)</p>
            <input type="text" placeholder="Search..." onkeyup="searchTable('payment-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="payment-table">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Member</th>
                  <th class="text-left p-3">Principal (रु)</th>
                  <th class="text-left p-3">Total Paid (रु)</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="payment-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="section-settings" class="hidden">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold mb-4">Create User</h3>
          <form onsubmit="createUser(event)" class="form-grid">
            <input type="text" id="newName" placeholder="Full Name" required class="px-4 py-2 border rounded-md">
            <input type="email" id="newEmail" placeholder="Email" required class="px-4 py-2 border rounded-md">
            <input type="password" id="newPassword" placeholder="Password" required class="px-4 py-2 border rounded-md">
            <select id="newRole" class="px-4 py-2 border rounded-md">
              <option value="admin">Admin</option>
              <option value="viewer">Viewer</option>
            </select>
            <div class="full">
              <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full md:w-auto">Create User</button>
            </div>
          </form>

          <h3 class="text-lg font-semibold mt-8 mb-4">All Users</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Name</th>
                  <th class="text-left p-3">Email</th>
                  <th class="text-left p-3">Role</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="user-list"></tbody>
            </table>
          </div>

          <h3 class="text-lg font-semibold mt-8 mb-4">Bulk Savings Entry</h3>
          <p class="text-sm text-gray-600 mb-4">Record the same saving amount for all <strong>active</strong> members for a specific month.</p>
          <form onsubmit="recordBulkSavings(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Month *</label>
              <input type="month" id="bulkSavingMonth" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Amount (रु) *</label>
              <input type="number" id="bulkSavingAmount" required class="w-full px-4 py-2 border rounded-md" placeholder="e.g., 500">
            </div>
            <div class="full">
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="bulkSavingStatus" class="w-full px-4 py-2 border rounded-md">
                    <option>Paid</option>
                    <option>Pending</option>
                </select>
            </div>
            <div class="full mt-2">
              <button type="submit" class="w-full md:w-auto bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                <i class="fas fa-users-cog mr-2"></i> Record for All Active Members
              </button>
            </div>
          </form>
          <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="downloadBackup()" class="bg-indigo-600 text-white px-6 py-3 rounded hover:bg-indigo-700 font-medium flex items-center justify-center">
              <i class="fas fa-download mr-2"></i> Download Backup
            </button>
            <label class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 font-medium flex items-center justify-center cursor-pointer">
              <i class="fas fa-upload mr-2"></i> Restore Backup
              <input type="file" id="restoreFile" accept=".json" onchange="restoreBackup(event)" class="hidden">
            </label>
          </div>
        </div>
      </section>

      <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8">
          <div class="flex justify-between items-start mb-6 border-b pb-4">
            <h3 id="reportTitle" class="text-2xl font-bold text-gray-800">Report</h3>
            <button onclick="closeModal('reportModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
          </div>
          <div id="reportContent" class="space-y-6"></div>
          <div class="mt-6 flex justify-end">
            <button onclick="closeModal('reportModal')" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Close</button>
          </div>
        </div>
      </div>

      <div id="addMemberModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Add New Member</h3>
          <form onsubmit="addMember(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Member ID *</label>
              <input type="text" id="memberId" readonly class="w-full px-4 py-2 border rounded-md bg-gray-100" placeholder="e.g., M001">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
              <input type="text" id="memberName" required class="w-full px-4 py-2 border rounded-md" placeholder="Enter full name">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
              <input type="text" id="memberPhone" class="w-full px-4 py-2 border rounded-md" placeholder="Enter phone number">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Join Date *</label>
              <input type="date" id="memberDate" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="memberStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Residential Address</label>
              <input type="text" id="memberAddress" class="w-full px-4 py-2 border rounded-md" placeholder="Enter residential address">
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('addMemberModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Member</button>
            </div>
          </form>
        </div>
      </div>

      <div id="addLoanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Distribute New Loan</h3>
          <form onsubmit="addLoan(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Member *</label>
              <select id="loanMemberId" required class="w-full px-4 py-2 border rounded-md">
                </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Principal Amount (रु) *</label>
              <input type="number" id="loanPrincipal" required class="w-full px-4 py-2 border rounded-md" placeholder="Enter loan amount">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Annual Interest Rate (%) *</label>
              <input type="number" id="loanRate" step="0.1" required class="w-full px-4 py-2 border rounded-md" placeholder="e.g., 12">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Loan Date *</label>
              <input type="date" id="loanDate" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Duration (Months) *</label>
              <input type="number" id="loanDuration" required class="w-full px-4 py-2 border rounded-md" placeholder="e.g., 12">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="loanStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('addLoanModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">Distribute Loan</button>
            </div>
          </form>
        </div>
      </div>

      <div id="addSavingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Record Monthly Saving</h3>
          <form onsubmit="addSaving(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Member *</label>
              <select id="savingMemberId" required class="w-full px-4 py-2 border rounded-md">
                <option value="">Select member</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Amount (रु) *</label>
              <input type="number" id="savingAmount" required class="w-full px-4 py-2 border rounded-md" placeholder="Enter amount">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Month *</label>
              <input type="month" id="savingMonth" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
              <select id="savingStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Paid</option>
                <option>Pending</option>
              </select>
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('addSavingModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Record Saving</button>
            </div>
          </form>
        </div>
      </div>

      <div id="addPaymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Record Loan Payment</h3>
          <form onsubmit="addPayment(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Select Loan *</label>
              <select id="paymentLoanId" required class="w-full px-4 py-2 border rounded-md">
                <option value="">Select active loan</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Month *</label>
              <input type="month" id="paymentMonth" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Interest Amount (रु) *</label>
              <input type="number" id="paymentInterest" required class="w-full px-4 py-2 border rounded-md" placeholder="Monthly interest" oninput="calculatePaymentTotal('paymentInterest', 'paymentPrincipal', 'paymentTotal')">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Principal Amount (रु)</label>
              <input type="number" id="paymentPrincipal" class="w-full px-4 py-2 border rounded-md" placeholder="Leave as 0 for interest-only payment" oninput="calculatePaymentTotal('paymentInterest', 'paymentPrincipal', 'paymentTotal')">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Total Payment (रु)</label>
              <input type="number" id="paymentTotal" readonly class="w-full px-4 py-2 border rounded-md bg-gray-100">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Date</label>
              <input type="date" id="paymentDate" class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
              <select id="paymentStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Pending</option>
                <option>Paid</option>
              </select>
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('addPaymentModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Record Payment</button>
            </div>
          </form>
        </div>
      </div>

      <div id="editMemberModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Edit Member</h3>
          <form onsubmit="saveEditedMember(event)" class="form-grid">
            <input type="hidden" id="editMemberId">
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
              <input type="text" id="editMemberName" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
              <input type="text" id="editMemberPhone" class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Join Date *</label>
              <input type="date" id="editMemberDate" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="editMemberStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Residential Address</label>
              <input type="text" id="editMemberAddress" class="w-full px-4 py-2 border rounded-md" placeholder="Enter residential address">
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('editMemberModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Update Member</button>
            </div>
          </form>
        </div>
      </div>

      <div id="editLoanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Edit Loan</h3>
          <form onsubmit="saveEditedLoan(event)" class="form-grid">
            <input type="hidden" id="editLoanId">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Member *</label>
              <select id="editLoanMemberId" required class="w-full px-4 py-2 border rounded-md">
                </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Principal Amount (रु) *</label>
              <input type="number" id="editLoanPrincipal" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Annual Interest Rate (%) *</label>
              <input type="number" id="editLoanRate" step="0.1" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Duration (Months) *</label>
              <input type="number" id="editLoanDuration" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Loan Date *</label>
              <input type="date" id="editLoanDate" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="editLoanStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('editLoanModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">Update Loan</button>
            </div>
          </form>
        </div>
      </div>

      <div id="editSavingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Edit Saving</h3>
          <form onsubmit="saveEditedSaving(event)" class="form-grid">
            <input type="hidden" id="editSavingId">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Member *</label>
              <select id="editSavingMemberId" required class="w-full px-4 py-2 border rounded-md">
                </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Amount (रु) *</label>
              <input type="number" id="editSavingAmount" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Month *</label>
              <input type="month" id="editSavingMonth" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
              <select id="editSavingStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Paid</option>
                <option>Pending</option>
              </select>
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('editSavingModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Update Saving</button>
            </div>
          </form>
        </div>
      </div>

      <div id="editPaymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Edit Payment</h3>
          <form onsubmit="saveEditedPayment(event)" class="form-grid">
            <input type="hidden" id="editPaymentId">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Select Loan *</label>
              <select id="editPaymentLoanId" required class="w-full px-4 py-2 border rounded-md">
                <option value="">Select active loan</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Month *</label>
              <input type="month" id="editPaymentMonth" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Interest Amount (रु) *</label>
              <input type="number" id="editPaymentInterest" required class="w-full px-4 py-2 border rounded-md" placeholder="Monthly interest" oninput="calculatePaymentTotal('editPaymentInterest', 'editPaymentPrincipal', 'editPaymentTotal')">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Principal Amount (रु)</label>
              <input type="number" id="editPaymentPrincipal" class="w-full px-4 py-2 border rounded-md" placeholder="Leave as 0 for interest-only payment" oninput="calculatePaymentTotal('editPaymentInterest', 'editPaymentPrincipal', 'editPaymentTotal')">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Total Payment (रु)</label>
              <input type="number" id="editPaymentTotal" readonly class="w-full px-4 py-2 border rounded-md bg-gray-100">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Date</label>
              <input type="date" id="editPaymentDate" class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
              <select id="editPaymentStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Pending</option>
                <option>Paid</option>
              </select>
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('editPaymentModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Update Payment</button>
            </div>
          </form>
        </div>
      </div>

  </div>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getDatabase, ref, onValue, set, push, remove, get } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyBd-ogOEv472kKWG9cLpbsFQBAK-i-0grw",
      authDomain: "thaleshwor-mahadev-samuh.firebaseapp.com",
      projectId: "thaleshwor-mahadev-samuh",
      storageBucket: "thaleshwor-mahadev-samuh.appspot.com",
      messagingSenderId: "590950394483",
      appId: "1:590950394483:web:24f9db2fb8a68295e49806",
      measurementId: "G-SQQB3TYVQD"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    const dbRefs = {
      users: ref(db, 'app/users'),
      members: ref(db, 'app/members'),
      savings: ref(db, 'app/savings'),
      loans: ref(db, 'app/loans'),
      payments: ref(db, 'app/payments')
    };

    let users = [], members = [], savings = [], loans = [], payments = [];
    let currentUser = null;

    onValue(dbRefs.users, (snapshot) => {
      users = snapshot.val() ? Object.values(snapshot.val()) : [];
    });
    onValue(dbRefs.members, (snapshot) => {
      members = snapshot.val() ? Object.values(snapshot.val()) : [];
      renderMembers();
      if (document.getElementById('section-dashboard').classList.contains('hidden') === false) loadDashboard();
    });
    onValue(dbRefs.savings, (snapshot) => {
      savings = snapshot.val() ? Object.values(snapshot.val()) : [];
      renderSavings();
      if (document.getElementById('section-dashboard').classList.contains('hidden') === false) loadDashboard();
    });
    onValue(dbRefs.loans, (snapshot) => {
      loans = snapshot.val() ? Object.values(snapshot.val()) : [];
      renderLoans();
      if (document.getElementById('section-dashboard').classList.contains('hidden') === false) loadDashboard();
    });
    onValue(dbRefs.payments, (snapshot) => {
      payments = snapshot.val() ? Object.values(snapshot.val()) : [];
      renderPayments();
      if (document.getElementById('section-dashboard').classList.contains('hidden') === false) loadDashboard();
    });

    async function addItem(refKey, item) {
      const newRef = push(dbRefs[refKey]);
      item.id = newRef.key;
      await set(newRef, item);
    }

    async function updateItem(refKey, id, updates) {
      await set(ref(db, `app/${refKey}/${id}`), updates);
    }

    async function deleteItem(refKey, id) {
      await remove(ref(db, `app/${refKey}/${id}`));
    }

    function handleSignIn(e) {
      e.preventDefault();
      const email = document.getElementById('signinEmail').value.trim().toLowerCase();
      const password = document.getElementById('signinPassword').value.trim();

      const user = users.find(u => u.email.toLowerCase() === email && u.password === password);

      if (!user) {
        alert("Invalid email or password.");
        return;
      }

      currentUser = user;
      localStorage.setItem("currentUser", JSON.stringify(user));
      document.getElementById("authModal").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      updateUserInfo();
      showSection('dashboard');
    }

    function logout() { 
      localStorage.removeItem("currentUser"); 
      location.reload(); 
    }

    function updateUserInfo() {
      const u = currentUser || JSON.parse(localStorage.getItem("currentUser") || 'null');
      if (!u) return;
      const name = u.name || u.email.split('@')[0];
      document.getElementById('userNameSmall').textContent = name;
      document.getElementById('userRoleSmall').textContent = u.role;
      document.getElementById('userAvatarSmall').textContent = name.charAt(0).toUpperCase();
    }

    function getIsAdmin() {
      const user = currentUser || JSON.parse(localStorage.getItem("currentUser") || 'null');
      return user && user.role === 'admin';
    }

    function checkAuthorization() {
      const isAdmin = getIsAdmin();
      document.getElementById('nav-settings').style.display = isAdmin ? 'flex' : 'none';
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? '' : 'none');
    }

    function showSection(id) {
      if (id === 'settings' && !getIsAdmin()) id = 'dashboard';
      document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
      document.getElementById(`section-${id}`).classList.remove('hidden');
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      document.getElementById(`nav-${id}`).classList.add('active');
      const titles = { dashboard: ['Dashboard','Overview'], members: ['Members','Manage'], savings: ['Savings','Track'], loans: ['Loans','Manage'], payments: ['Payments','Track'], settings: ['Settings','Users'] };
      document.getElementById('headerTitle').textContent = titles[id][0];
      document.getElementById('headerSubtitle').textContent = titles[id][1];
      if (id === 'dashboard') loadDashboard();
      else if (id === 'members') renderMembers();
      else if (id === 'savings') renderSavings();
      else if (id === 'loans') renderLoans();
      else if (id === 'payments') renderPayments();
      else if (id === 'settings') renderUsers();
      checkAuthorization();
    }

    let lineChart, pieChart;
    function loadDashboard() { updateStats(); renderLineChart(); renderPieChart(); updateDefaulters(); }

    function updateStats() {
      document.getElementById('stat-members').textContent = members.length;
      const totalSavings = savings.reduce((a,s)=>a+(parseFloat(s.amount)||0),0);
      document.getElementById('stat-savings').textContent = `रु${totalSavings.toLocaleString()}`;
      const activeLoans = loans.filter(l=>l.status==='Active').reduce((a,l)=>a+(parseFloat(l.balance)||0),0);
      document.getElementById('stat-loans').textContent = `रु${activeLoans.toLocaleString()}`;
      const totalInterest = payments.reduce((a,p)=>a+(parseFloat(p.interest)||0),0);
      document.getElementById('stat-interest').textContent = `रु${totalInterest.toLocaleString()}`;
      const availableBalance = totalSavings - activeLoans;
      document.getElementById('stat-balance').textContent = `रु${availableBalance.toLocaleString()}`;
      const allMonths = getAllMonths();
      if (allMonths.length < 2) {
        document.getElementById('stat-growth').textContent = '0%';
      } else {
        const savingsByMonth = aggregateByMonth(savings, 'month', 'amount');
        const first = savingsByMonth[allMonths[0]] || 0;
        const last  = savingsByMonth[allMonths[allMonths.length-1]] || 0;
        const growth = first === 0 ? 0 : ((last - first) / first) * 100;
        const sign = growth > 0 ? '+' : '';
        document.getElementById('stat-growth').textContent = `${sign}${growth.toFixed(1)}%`;
      }
    }

    function renderLineChart() {
      const ctx = document.getElementById('lineChart').getContext('2d');
      if (lineChart) lineChart.destroy();
      const allMonths = getAllMonths();
      const savingsMap = aggregateByMonth(savings, 'month', 'amount');
      const loanMap = aggregateByMonth(loans, 'date', 'principal');
      const savingsData = fillMissingMonths(allMonths, savingsMap);
      const loanData = fillMissingMonths(allMonths, loanMap);
      const labels = allMonths.map(m => {
        const [y,mm] = m.split('-');
        const date = new Date(y, mm-1);
        return date.toLocaleString('en-US', { month:'short', year:'2-digit' });
      });
      lineChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [
        { label: 'Savings', data: savingsData, borderColor: '#10b981', tension: 0.4 },
        { label: 'Loans', data: loanData, borderColor: '#3b82f6', tension: 0.4 }
      ]}, options: { responsive: true, plugins: { legend: { position: 'bottom' } }, maintainAspectRatio: false } });
    }

    function renderPieChart() {
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      const loanTotalsByMember = {};
      loans.forEach(loan => {
        const member = members.find(m => m.id === loan.memberId);
        const name = member?.name || 'Unknown';
        const principal = parseFloat(loan.principal) || 0;
        loanTotalsByMember[name] = (loanTotalsByMember[name] || 0) + principal;
      });
      const labels = Object.keys(loanTotalsByMember);
      const data = Object.values(loanTotalsByMember);
      const chartColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1', '#14b8a6', '#d946ef'];
      const backgroundColors = labels.map((_, i) => chartColors[i % chartColors.length]);
      pieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: backgroundColors }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } }, maintainAspectRatio: false } });
    }

    function updateDefaulters() {
      const month = new Date().toISOString().slice(0,7);
      const paidSavings = new Set(savings.filter(s=>s.month===month).map(s=>s.memberId));
      document.getElementById('defaulters-savings').textContent = members.filter(m=>!paidSavings.has(m.id)).length;
      const paidLoans = new Set(payments.filter(p=>p.month===month).map(p=>p.loanId));
      document.getElementById('defaulters-loans').textContent = loans.filter(l=>l.status==='Active' && !paidLoans.has(l.id)).length;
    }

    function renderMembers() {
      const tbody = document.getElementById('member-list');
      document.getElementById('member-count').textContent = members.length;
      tbody.innerHTML = members.map(m=>`
        <tr class="border-b hover:bg-gray-50">
          <td class="p-3">${m.id}</td>
          <td class="p-3">${m.name}</td>
          <td class="p-3">${m.phone||'-'}</td>
          <td class="p-3">${m.joinDate}</td>
          <td class="p-3"><span class="${m.status==='Active'?'badge-active':'badge-inactive'}">${m.status}</span></td>
          <td class="p-3 space-x-2">
            <button onclick="showReportModal('member', '${m.id}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">Review Report</button>
            <button onclick="openEditMember('${m.id}')" class="text-blue-600 hover:underline text-xs admin-only">Edit</button>
            <button onclick="deleteMember('${m.id}')" class="text-red-600 hover:underline text-xs admin-only">Delete</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="6" class="p-3 text-center text-gray-500">No members</td></tr>';
    }

    function renderSavings() {
      const tbody = document.getElementById('saving-list');
      const grouped = Object.values(savings.reduce((acc, s) => {
        if (!acc[s.memberId]) acc[s.memberId] = { total: 0, memberId: s.memberId };
        acc[s.memberId].total += parseFloat(s.amount) || 0;
        return acc;
      }, {}));
      document.getElementById('saving-count').textContent = grouped.length;
      tbody.innerHTML = grouped.map(g => {
        const m = members.find(x => x.id === g.memberId);
        return `<tr class="border-b hover:bg-gray-50">
          <td class="p-3">${m?.name || 'Unknown'}</td>
          <td class="p-3 font-semibold">रु${g.total.toLocaleString()}</td>
          <td class="p-3">
            <button onclick="showReportModal('savings', '${g.memberId}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">Review Report</button>
          </td>
        </tr>`;
      }).join('') || '<tr><td colspan="3" class="p-3 text-center text-gray-500">No savings</td></tr>';
    }

    function renderLoans() {
      const tbody = document.getElementById('loan-list');
      document.getElementById('loan-count').textContent = loans.length;
      tbody.innerHTML = loans.map(l => {
        const m = members.find(x => x.id === l.memberId);
        return `<tr class="border-b hover:bg-gray-50">
          <td class="p-3">${m?.name || 'Unknown'}</td>
          <td class="p-3">रु${(l.principal || 0).toLocaleString()}</td>
          <td class="p-3 font-semibold">रु${(l.balance || 0).toLocaleString()}</td>
          <td class="p-3">${l.rate || 0}%</td>
          <td class="p-3">${l.date || '-'}</td>
          <td class="p-3"><span class="${(l.status==='Active'?'badge-active':'badge-inactive')}">${l.status || 'N/A'}</span></td>
          <td class="p-3 space-x-2">
            <button onclick="showReportModal('loan', '${l.id}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">Review Report</button>
            <button onclick="openEditLoan('${l.id}')" class="text-blue-600 hover:underline text-xs admin-only">Edit</button>
            <button onclick="deleteLoan('${l.id}')" class="text-red-600 hover:underline text-xs admin-only">Delete</button>
          </td>
        </tr>`;
      }).join('') || '<tr><td colspan="7" class="p-3 text-center text-gray-500">No loans</td></tr>';
      checkAuthorization();
    }

    function renderPayments() {
      const tbody = document.getElementById('payment-list');
      const grouped = Object.values(payments.reduce((acc, p) => {
        if (!acc[p.loanId]) acc[p.loanId] = { total: 0, loanId: p.loanId };
        acc[p.loanId].total += parseFloat(p.total) || 0;
        return acc;
      }, {}));
      document.getElementById('payment-count').textContent = grouped.length;
      tbody.innerHTML = grouped.map(g => {
        const l = loans.find(x => x.id === g.loanId);
        const m = members.find(x => x.id === l?.memberId);
        return `<tr class="border-b hover:bg-gray-50">
          <td class="p-3">${m?.name || 'Unknown'}</td>
          <td class="p-3">रु${(l?.principal || 0).toLocaleString()}</td>
          <td class="p-3 font-semibold">रु${g.total.toLocaleString()}</td>
          <td class="p-3">
            <button onclick="showReportModal('payments', '${g.loanId}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">Review Report</button>
          </td>
        </tr>`;
      }).join('') || '<tr><td colspan="4" class="p-3 text-center text-gray-500">No payments</td></tr>';
    }

    function renderUsers() {
      const tbody = document.getElementById('user-list');
      tbody.innerHTML = users.map(u => `
        <tr class="border-b">
          <td class="p-3">${u.name}</td>
          <td class="p-3">${u.email}</td>
          <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${u.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">${u.role}</span></td>
          <td class="p-3">
            ${u.email !== 'example.admin@gmail.com' ? `<button onclick="deleteUser('${u.email}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
          </td>
        </tr>
      `).join('');
    }

    function showAddMemberForm() {
      if (!getIsAdmin()) return alert("Admins only");
      document.getElementById('memberId').value = generateMemberId();
      document.getElementById('memberDate').valueAsDate = new Date();
      document.getElementById('addMemberModal').classList.remove('hidden');
    }

    async function addMember(e) {
      e.preventDefault();
      const m = {
        id: document.getElementById('memberId').value,
        name: document.getElementById('memberName').value,
        phone: document.getElementById('memberPhone').value,
        joinDate: document.getElementById('memberDate').value,
        status: document.getElementById('memberStatus').value,
        address: document.getElementById('memberAddress').value
      };
      await addItem('members', m);
      closeModal('addMemberModal');
    }

    function openEditMember(id) {
      if (!getIsAdmin()) return alert("Admins only");
      const m = members.find(x => x.id === id);
      if (!m) return alert('Member not found');
      document.getElementById('editMemberId').value = m.id;
      document.getElementById('editMemberName').value = m.name;
      document.getElementById('editMemberPhone').value = m.phone;
      document.getElementById('editMemberDate').value = m.joinDate;
      document.getElementById('editMemberStatus').value = m.status;
      document.getElementById('editMemberAddress').value = m.address;
      document.getElementById('editMemberModal').classList.remove('hidden');
      closeModal('reportModal');
    }

    async function saveEditedMember(e) {
      e.preventDefault();
      const id = document.getElementById('editMemberId').value;
      const updates = {
        name: document.getElementById('editMemberName').value,
        phone: document.getElementById('editMemberPhone').value,
        joinDate: document.getElementById('editMemberDate').value,
        status: document.getElementById('editMemberStatus').value,
        address: document.getElementById('editMemberAddress').value
      };
      await updateItem('members', id, updates);
      closeModal('editMemberModal');
    }

    async function deleteMember(id) {
      if (!confirm("Delete member?")) return;
      await deleteItem('members', id);
      // Also delete related savings, loans, payments if needed
      savings.filter(s => s.memberId === id).forEach(async s => await deleteItem('savings', s.id));
      loans.filter(l => l.memberId === id).forEach(async l => {
        await deleteItem('loans', l.id);
        payments.filter(p => p.loanId === l.id).forEach(async p => await deleteItem('payments', p.id));
      });
      closeModal('reportModal');
    }

    function showLoanForm() {
      if (!getIsAdmin()) return alert("Admins only");
      const select = document.getElementById('loanMemberId');
      select.innerHTML = members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
      document.getElementById('loanDate').valueAsDate = new Date();
      document.getElementById('addLoanModal').classList.remove('hidden');
    }

    async function addLoan(e) {
      e.preventDefault();
      const principal = parseFloat(document.getElementById('loanPrincipal').value);
      const l = {
        memberId: document.getElementById('loanMemberId').value,
        principal,
        balance: principal,
        rate: parseFloat(document.getElementById('loanRate').value),
        duration: parseInt(document.getElementById('loanDuration').value),
        date: document.getElementById('loanDate').value,
        status: document.getElementById('loanStatus').value
      };
      await addItem('loans', l);
      closeModal('addLoanModal');
    }

    function openEditLoan(id) {
      if (!getIsAdmin()) return alert("Admins only");
      const l = loans.find(x => x.id === id);
      if (!l) return alert('Loan not found');
      document.getElementById('editLoanId').value = l.id;
      const select = document.getElementById('editLoanMemberId');
      select.innerHTML = members.map(m => `<option value="${m.id}" ${m.id === l.memberId ? 'selected' : ''}>${m.name}</option>`).join('');
      document.getElementById('editLoanPrincipal').value = l.principal;
      document.getElementById('editLoanRate').value = l.rate;
      document.getElementById('editLoanDuration').value = l.duration;
      document.getElementById('editLoanDate').value = l.date;
      document.getElementById('editLoanStatus').value = l.status;
      document.getElementById('editLoanModal').classList.remove('hidden');
      closeModal('reportModal');
    }

    async function saveEditedLoan(e) {
      e.preventDefault();
      const id = document.getElementById('editLoanId').value;
      const updates = {
        memberId: document.getElementById('editLoanMemberId').value,
        principal: parseFloat(document.getElementById('editLoanPrincipal').value),
        rate: parseFloat(document.getElementById('editLoanRate').value),
        duration: parseInt(document.getElementById('editLoanDuration').value),
        date: document.getElementById('editLoanDate').value,
        status: document.getElementById('editLoanStatus').value
      };
      updates.balance = updates.principal; // Assume balance resets on edit; adjust if needed
      await updateItem('loans', id, updates);
      closeModal('editLoanModal');
    }

    async function deleteLoan(id) {
      if (!confirm("Delete loan?")) return;
      await deleteItem('loans', id);
      payments.filter(p => p.loanId === id).forEach(async p => await deleteItem('payments', p.id));
      closeModal('reportModal');
    }

    function showSavingForm() {
      if (!getIsAdmin()) return alert("Admins only");
      const select = document.getElementById('savingMemberId');
      select.innerHTML = members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
      document.getElementById('addSavingModal').classList.remove('hidden');
    }

    async function addSaving(e) {
      e.preventDefault();
      const s = {
        memberId: document.getElementById('savingMemberId').value,
        amount: parseFloat(document.getElementById('savingAmount').value),
        month: document.getElementById('savingMonth').value,
        status: document.getElementById('savingStatus').value
      };
      await addItem('savings', s);
      closeModal('addSavingModal');
    }

    function openEditSaving(id) {
      if (!getIsAdmin()) return alert("Admins only");
      const s = savings.find(x => x.id === id);
      if (!s) return alert('Saving not found');
      document.getElementById('editSavingId').value = s.id;
      const select = document.getElementById('editSavingMemberId');
      select.innerHTML = members.map(m => `<option value="${m.id}" ${m.id === s.memberId ? 'selected' : ''}>${m.name}</option>`).join('');
      document.getElementById('editSavingAmount').value = s.amount;
      document.getElementById('editSavingMonth').value = s.month;
      document.getElementById('editSavingStatus').value = s.status;
      document.getElementById('editSavingModal').classList.remove('hidden');
      closeModal('reportModal');
    }

    async function saveEditedSaving(e) {
      e.preventDefault();
      const id = document.getElementById('editSavingId').value;
      const updates = {
        memberId: document.getElementById('editSavingMemberId').value,
        amount: parseFloat(document.getElementById('editSavingAmount').value),
        month: document.getElementById('editSavingMonth').value,
        status: document.getElementById('editSavingStatus').value
      };
      await updateItem('savings', id, updates);
      closeModal('editSavingModal');
    }

    async function deleteSaving(id) {
      if (!confirm("Delete saving?")) return;
      await deleteItem('savings', id);
      closeModal('reportModal');
    }

    function showPaymentForm() {
      if (!getIsAdmin()) return alert("Admins only");
      const activeLoans = loans.filter(l => l.status === 'Active');
      if (activeLoans.length === 0) return alert("No active loans.");
      const select = document.getElementById('paymentLoanId');
      select.innerHTML = activeLoans.map(l => {
        const m = members.find(x => x.id === l.memberId);
        return `<option value="${l.id}">${m?.name || 'Unknown'} - रु${(l.balance || 0).toLocaleString()}</option>`;
      }).join('');
      document.getElementById('paymentMonth').valueAsDate = new Date();
      document.getElementById('paymentDate').valueAsDate = new Date();
      document.getElementById('paymentTotal').value = '0.00';
      document.getElementById('addPaymentModal').classList.remove('hidden');
    }

    async function addPayment(e) {
      e.preventDefault();
      const p = {
        loanId: document.getElementById('paymentLoanId').value,
        month: document.getElementById('paymentMonth').value,
        interest: parseFloat(document.getElementById('paymentInterest').value) || 0,
        principal: parseFloat(document.getElementById('paymentPrincipal').value) || 0,
        total: parseFloat(document.getElementById('paymentTotal').value) || 0,
        date: document.getElementById('paymentDate').value,
        status: document.getElementById('paymentStatus').value
      };
      await addItem('payments', p);
      await updateLoanBalance(p.loanId);
      closeModal('addPaymentModal');
    }

    function openEditPayment(id) {
      if (!getIsAdmin()) return alert("Admins only");
      const p = payments.find(x => x.id === id);
      if (!p) return alert('Payment not found');
      document.getElementById('editPaymentId').value = p.id;
      const select = document.getElementById('editPaymentLoanId');
      select.innerHTML = loans.map(l => `<option value="${l.id}" ${l.id === p.loanId ? 'selected' : ''}>${members.find(m => m.id === l.memberId)?.name}</option>`).join('');
      document.getElementById('editPaymentMonth').value = p.month;
      document.getElementById('editPaymentInterest').value = p.interest;
      document.getElementById('editPaymentPrincipal').value = p.principal;
      document.getElementById('editPaymentTotal').value = p.total;
      document.getElementById('editPaymentDate').value = p.date;
      document.getElementById('editPaymentStatus').value = p.status;
      document.getElementById('editPaymentModal').classList.remove('hidden');
      closeModal('reportModal');
    }

    async function saveEditedPayment(e) {
      e.preventDefault();
      const id = document.getElementById('editPaymentId').value;
      const updates = {
        loanId: document.getElementById('editPaymentLoanId').value,
        month: document.getElementById('editPaymentMonth').value,
        interest: parseFloat(document.getElementById('editPaymentInterest').value) || 0,
        principal: parseFloat(document.getElementById('editPaymentPrincipal').value) || 0,
        total: parseFloat(document.getElementById('editPaymentTotal').value) || 0,
        date: document.getElementById('editPaymentDate').value,
        status: document.getElementById('editPaymentStatus').value
      };
      await updateItem('payments', id, updates);
      await updateLoanBalance(updates.loanId);
      closeModal('editPaymentModal');
    }

    async function deletePayment(id) {
      if (!confirm("Delete payment?")) return;
      await deleteItem('payments', id);
      closeModal('reportModal');
    }

    async function updateLoanBalance(loanId) {
      const loan = loans.find(l => l.id === loanId);
      if (!loan) return;
      const paid = payments.filter(p => p.loanId === loanId).reduce((a, p) => a + (parseFloat(p.principal) || 0), 0);
      const updates = { balance: loan.principal - paid, status: (loan.principal - paid) <= 0 ? 'Inactive' : 'Active' };
      await updateItem('loans', loanId, updates);
    }

    function getAllMonths() {
      const months = new Set();
      savings.forEach(s => months.add(s.month));
      loans.forEach(l => months.add(l.date.slice(0,7)));
      payments.forEach(p => months.add(p.month));
      return Array.from(months).sort();
    }

    function aggregateByMonth(arr, key, valueKey) {
      const map = {};
      arr.forEach(item => {
        const month = item[key].slice(0,7);
        map[month] = (map[month] || 0) + (parseFloat(item[valueKey]) || 0);
      });
      return map;
    }

    function fillMissingMonths(months, dataMap) {
      return months.map(m => dataMap[m] || 0);
    }

    function generateId(prefix) { return prefix + Date.now().toString(36); }

    function generateMemberId() {
      const year = new Date().getFullYear().toString().slice(-2);
      const count = members.length + 1; // Simple count; adjust if needed
      return `M${year}${String(count).padStart(3, '0')}`;
    }

    function calculatePaymentTotal(interestId, principalId, totalId) {
      const interest = parseFloat(document.getElementById(interestId).value) || 0;
      const principal = parseFloat(document.getElementById(principalId).value) || 0;
      document.getElementById(totalId).value = (interest + principal).toFixed(2);
    }

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    function searchTable(tableId, query) {
      const rows = document.querySelectorAll(`#${tableId} tbody tr`);
      rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none');
    }

    async function createUser(e) {
      e.preventDefault();
      const email = document.getElementById('newEmail').value.trim().toLowerCase();
      if (users.some(u => u.email.toLowerCase() === email)) return alert("Email exists");
      const u = {
        email,
        password: document.getElementById('newPassword').value,
        name: document.getElementById('newName').value,
        role: document.getElementById('newRole').value
      };
      await addItem('users', u);
      e.target.reset();
    }

    async function deleteUser(email) {
      if (!confirm("Delete user?")) return;
      const id = users.find(u => u.email === email).id;
      await deleteItem('users', id);
    }

    async function recordBulkSavings(e) {
      e.preventDefault();
      const month = document.getElementById('bulkSavingMonth').value;
      const amount = parseFloat(document.getElementById('bulkSavingAmount').value);
      const status = document.getElementById('bulkSavingStatus').value;
      const activeMembers = members.filter(m => m.status === 'Active');
      for (const member of activeMembers) {
        const existing = savings.find(s => s.memberId === member.id && s.month === month);
        if (!existing) {
          const newSaving = {
            memberId: member.id,
            amount,
            month,
            status
          };
          await addItem('savings', newSaving);
        }
      }
      e.target.reset();
    }

    function showReportModal(type, id) {
      const modal = document.getElementById('reportModal');
      const content = document.getElementById('reportContent');
      const title = document.getElementById('reportTitle');
      let html = '';
      const isAdmin = getIsAdmin();

      if (type === 'member') {
        const member = members.find(m => m.id === id);
        if (!member) return alert("Member not found");

        const memberSavings = savings.filter(s => s.memberId === id);
        const memberLoans = loans.filter(l => l.memberId === id);
        const memberPayments = payments.filter(p => memberLoans.some(l => l.id === p.loanId));

        const totalSavings = memberSavings.reduce((a, s) => a + (parseFloat(s.amount) || 0), 0);
        const totalLoan = memberLoans.reduce((a, l) => a + (parseFloat(l.principal) || 0), 0);
        const totalPaid = memberPayments.reduce((a, p) => a + (parseFloat(p.total) || 0), 0);

        title.textContent = `${member.name} – Member Summary`;
        html += `
          <div class="space-y-2 mb-4">
            <p><strong>Member ID:</strong> ${member.id}</p>
            <p><strong>Name:</strong> ${member.name}</p>
            <p><strong>Phone:</strong> ${member.phone || '-'}</p>
            <p><strong>Join Date:</strong> ${member.joinDate}</p>
            <p><strong>Status:</strong> <span class="${member.status==='Active'?'badge-active':'badge-inactive'}">${member.status}</span></p>
            <p><strong>Address:</strong> ${member.address || '-'}</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-green-50 border border-green-200 p-3 rounded-lg text-center">
              <p class="text-sm text-gray-600">Total Savings</p>
              <p class="text-2xl font-bold text-green-700">रु${totalSavings.toLocaleString()}</p>
            </div>
            <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg text-center">
              <p class="text-sm text-gray-600">Total Loans</p>
              <p class="text-2xl font-bold text-blue-700">रु${totalLoan.toLocaleString()}</p>
            </div>
            <div class="bg-purple-50 border border-purple-200 p-3 rounded-lg text-center">
              <p class="text-sm text-gray-600">Total Paid (Principal+Interest)</p>
              <p class="text-2xl font-bold text-purple-700">रु${totalPaid.toLocaleString()}</p>
            </div>
          </div>
          ${isAdmin ? `<div class="mb-6 flex justify-end">
            <button onclick="openEditMember('${member.id}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm mr-2">Edit Member</button>
            <button onclick="deleteMember('${member.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm">Delete Member</button>
          </div>` : ''}
          
          <h4 class="text-lg font-semibold border-b pb-2 mt-6 mb-4">Savings History</h4>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Month</th>
                  <th class="text-left p-3">Amount (रु)</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">${isAdmin ? 'Actions' : ''}</th>
                </tr>
              </thead>
              <tbody>
                ${memberSavings.map(s => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${s.month}</td>
                    <td class="p-3">रु${(s.amount || 0).toLocaleString()}</td>
                    <td class="p-3"><span class="${s.status==='Paid'?'badge-active':'badge-inactive'}">${s.status}</span></td>
                    <td class="p-3 space-x-2">
                      ${isAdmin ? `<button onclick="openEditSaving('${s.id}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                      <button onclick="deleteSaving('${s.id}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
                    </td>
                  </tr>
                `).join('') || '<tr><td colspan="4" class="p-3 text-center text-gray-500">No savings recorded.</td></tr>'}
              </tbody>
            </table>
          </div>

          <h4 class="text-lg font-semibold border-b pb-2 mt-8 mb-4">Loans Summary</h4>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Loan ID</th>
                  <th class="text-left p-3">Principal (रु)</th>
                  <th class="text-left p-3">Balance (रु)</th>
                  <th class="text-left p-3">Rate (%)</th>
                  <th class="text-left p-3">Date</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${memberLoans.map(l => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${l.id}</td>
                    <td class="p-3">रु${(l.principal || 0).toLocaleString()}</td>
                    <td class="p-3">रु${(l.balance || 0).toLocaleString()}</td>
                    <td class="p-3">${l.rate || 0}%</td>
                    <td class="p-3">${l.date || '-'}</td>
                    <td class="p-3"><span class="${l.status==='Active'?'badge-active':'badge-inactive'}">${l.status || 'N/A'}</span></td>
                    <td class="p-3 space-x-2">
                      <button onclick="showReportModal('loan', '${l.id}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">View Details</button>
                      ${isAdmin ? `<button onclick="openEditLoan('${l.id}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                      <button onclick="deleteLoan('${l.id}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
                    </td>
                  </tr>
                `).join('') || '<tr><td colspan="7" class="p-3 text-center text-gray-500">No loans recorded.</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
        content.innerHTML = html;
      } else if (type === 'loan') {
        const loan = loans.find(l => l.id === id);
        if (!loan) return alert("Loan not found");
        const member = members.find(m => m.id === loan.memberId);
        const loanPayments = payments.filter(p => p.loanId === id).sort((a,b) => b.month.localeCompare(a.month));

        const totalInterestPaid = loanPayments.reduce((a, p) => a + (parseFloat(p.interest) || 0), 0);
        const totalPrincipalPaid = loanPayments.reduce((a, p) => a + (parseFloat(p.principal) || 0), 0);
        const totalPaid = totalInterestPaid + totalPrincipalPaid;

        title.textContent = `${member?.name || 'Unknown'} – Loan Report (${loan.id})`;
        html += `
          <div class="space-y-2 mb-4">
            <p><strong>Loan ID:</strong> ${loan.id}</p>
            <p><strong>Member:</strong> ${member?.name || 'Unknown'}</p>
            <p><strong>Principal Amount:</strong> रु${(loan.principal || 0).toLocaleString()}</p>
            <p><strong>Annual Rate:</strong> ${loan.rate || 0}%</p>
            <p><strong>Duration:</strong> ${loan.duration || 0} months</p>
            <p><strong>Start Date:</strong> ${loan.date || '-'}</p>
            <p><strong>Status:</strong> <span class="${loan.status==='Active'?'badge-active':'badge-inactive'}">${loan.status || 'N/A'}</span></p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-red-50 border border-red-200 p-3 rounded-lg text-center">
              <p class="text-sm text-gray-600">Outstanding Balance</p>
              <p class="text-2xl font-bold text-red-700">रु${(loan.balance || 0).toLocaleString()}</p>
            </div>
            <div class="bg-purple-50 border border-purple-200 p-3 rounded-lg text-center">
              <p class="text-sm text-gray-600">Principal Paid</p>
              <p class="text-2xl font-bold text-purple-700">रु${totalPrincipalPaid.toLocaleString()}</p>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-center">
              <p class="text-sm text-gray-600">Interest Paid</p>
              <p class="text-2xl font-bold text-yellow-700">रु${totalInterestPaid.toLocaleString()}</p>
            </div>
          </div>
          ${isAdmin ? `<div class="mb-6 flex justify-end">
            <button onclick="openEditLoan('${loan.id}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm mr-2">Edit Loan</button>
            <button onclick="deleteLoan('${loan.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm">Delete Loan</button>
          </div>` : ''}

          <h4 class="text-lg font-semibold border-b pb-2 mt-6 mb-4">Payment History</h4>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Payment ID</th>
                  <th class="text-left p-3">Month</th>
                  <th class="text-left p-3">Interest (रु)</th>
                  <th class="text-left p-3">Principal (रु)</th>
                  <th class="text-left p-3">Total (रु)</th>
                  <th class="text-left p-3">Date</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">${isAdmin ? 'Actions' : ''}</th>
                </tr>
              </thead>
              <tbody>
                ${loanPayments.map(p => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${p.id}</td>
                    <td class="p-3">${p.month}</td>
                    <td class="p-3">रु${(p.interest || 0).toLocaleString()}</td>
                    <td class="p-3">रु${(p.principal || 0).toLocaleString()}</td>
                    <td class="p-3 font-semibold">रु${(p.total || 0).toLocaleString()}</td>
                    <td class="p-3">${p.date || '-'}</td>
                    <td class="p-3"><span class="${p.status==='Paid'?'badge-active':'badge-inactive'}">${p.status}</span></td>
                    <td class="p-3 space-x-2">
                      ${isAdmin ? `<button onclick="openEditPayment('${p.id}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                      <button onclick="deletePayment('${p.id}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
                    </td>
                  </tr>
                `).join('') || '<tr><td colspan="8" class="p-3 text-center text-gray-500">No payments recorded for this loan.</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
        content.innerHTML = html;
      } else if (type === 'savings') {
        const memberId = id;
        const member = members.find(m => m.id === memberId);
        const monthlySavings = savings.filter(s => s.memberId === memberId).sort((a,b) => b.month.localeCompare(a.month));

        title.textContent = `${member?.name || 'Unknown'} – All Savings Records`;
        html += `
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Saving ID</th>
                  <th class="text-left p-3">Month</th>
                  <th class="text-left p-3">Amount (रु)</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">${isAdmin ? 'Actions' : ''}</th>
                </tr>
              </thead>
              <tbody>
                ${monthlySavings.map(s => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${s.id}</td>
                    <td class="p-3">${s.month}</td>
                    <td class="p-3">रु${(s.amount || 0).toLocaleString()}</td>
                    <td class="p-3"><span class="${s.status==='Paid'?'badge-active':'badge-inactive'}">${s.status}</span></td>
                    <td class="p-3 space-x-2">
                      ${isAdmin ? `<button onclick="openEditSaving('${s.id}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                      <button onclick="deleteSaving('${s.id}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
                    </td>
                  </tr>
                `).join('') || '<tr><td colspan="5" class="p-3 text-center text-gray-500">No savings records found.</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
        content.innerHTML = html;
      } else if (type === 'payments') {
        const loanId = id;
        const loan = loans.find(l => l.id === loanId);
        const member = members.find(m => m.id === loan?.memberId);
        const allPayments = payments.filter(p => p.loanId === loanId).sort((a,b) => b.month.localeCompare(a.month));
        
        title.textContent = `${member?.name || 'Unknown'} – All Payments for Loan (${loan?.id})`;
        html += `
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Payment ID</th>
                  <th class="text-left p-3">Month</th>
                  <th class="text-left p-3">Interest (रु)</th>
                  <th class="text-left p-3">Principal (रु)</th>
                  <th class="text-left p-3">Total (रु)</th>
                  <th class="text-left p-3">Date</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">${isAdmin ? 'Actions' : ''}</th>
                </tr>
              </thead>
              <tbody>
                ${allPayments.map(p => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${p.id}</td>
                    <td class="p-3">${p.month}</td>
                    <td class="p-3">रु${(p.interest || 0).toLocaleString()}</td>
                    <td class="p-3">रु${(p.principal || 0).toLocaleString()}</td>
                    <td class="p-3 font-semibold">रु${(p.total || 0).toLocaleString()}</td>
                    <td class="p-3">${p.date || '-'}</td>
                    <td class="p-3"><span class="${p.status==='Paid'?'badge-active':'badge-inactive'}">${p.status}</span></td>
                    <td class="p-3 space-x-2">
                      ${isAdmin ? `<button onclick="openEditPayment('${p.id}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                      <button onclick="deletePayment('${p.id}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
                    </td>
                  </tr>
                `).join('') || '<tr><td colspan="8" class="p-3 text-center text-gray-500">No payments recorded for this loan.</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
        content.innerHTML = html;
      }
      modal.classList.remove('hidden');
    }

    window.onload = () => {
      if (localStorage.getItem("currentUser")) {
        currentUser = JSON.parse(localStorage.getItem("currentUser"));
        document.getElementById("authModal").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        updateUserInfo();
        showSection('dashboard');
      }
    };
  </script>
</body>
</html>
